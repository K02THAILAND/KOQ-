<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการผู้ใช้ | Coffee Spark AI Barista</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
      // ข้อมูลการเชื่อมต่อ (ดึงมาจาก Project Settings ของคุณ)
      const firebaseConfig = {
        apiKey: "AlzaSyAuuW73UKcpg9m5Uu810pv0D0BK50ExnDU", 
        authDomain: "coffee-spark-ai-barista-ece33.firebaseapp.com", 
        projectId: "coffee-spark-ai-barista-ece33", 
        storageBucket: "coffee-spark-ai-barista-ece33.appspot.com",
        messagingSenderId: "526361372769",
        appId: "1:526361372769:web:1590fd8a8725c8f011e220" 
      };
      
      // เริ่มต้น Firebase และบริการที่ใช้
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      console.log("Firebase App และ Services ถูกเริ่มต้นแล้ว");
    </script>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        input[type="email"], input[type="password"] { width: 100%; padding: 10px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; padding: 12px 20px; margin: 10px 0; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover { background-color: #45a049; }
        #regMessage, #loginMessage { margin-top: 10px; text-align: center; }
        .error { color: #f44336; }
        .success { color: #4CAF50; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ลงทะเบียน (Register)</h2>
        <input type="email" id="regEmail" placeholder="Email" required>
        <input type="password" id="regPassword" placeholder="Password (ขั้นต่ำ 6 ตัว)" required>
        <button onclick="registerUser()">ลงทะเบียน</button>
        <p id="regMessage" class="error"></p>

        <hr style="margin: 30px 0;">

        <h2>เข้าสู่ระบบ (Login)</h2>
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button onclick="loginUser()">เข้าสู่ระบบ</button>
        <p id="loginMessage" class="error"></p>
    </div>

    <script>
        // ฟังก์ชันลงทะเบียนผู้ใช้ใหม่
        function registerUser() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const regMessage = document.getElementById('regMessage');

            regMessage.className = 'error';
            if (!email || !password || password.length < 6) {
                regMessage.textContent = 'กรุณากรอก Email และ Password ให้ถูกต้อง (Password ขั้นต่ำ 6 ตัว)';
                return;
            }
            
            // 1. สร้างบัญชีใน Firebase Authentication
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // กำหนดวันหมดอายุ (หมดอายุใน 30 วันนับจากนี้)
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30); 

                    // 2. บันทึกข้อมูลเสริม (วันหมดอายุ, role) ลงใน Firestore
                    return db.collection("users").doc(user.uid).set({
                        email: user.email,
                        role: "standard", 
                        expiryDate: firebase.firestore.Timestamp.fromDate(expiryDate) 
                    });
                })
                .then(() => {
                    // กำหนด expiryDate อีกครั้งเพื่อให้แสดงผลใน .then() ได้
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30); 
                    
                    regMessage.className = 'success';
                    regMessage.textContent = `ลงทะเบียนสำเร็จ! บัญชีของคุณมีอายุถึง ${expiryDate.toLocaleDateString('th-TH')} `;
                })
                .catch((error) => {
                    regMessage.className = 'error';
                    regMessage.textContent = 'ลงทะเบียนล้มเหลว: ' + error.message;
                });
        }

        // ฟังก์ชันเข้าสู่ระบบ
        function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginMessage = document.getElementById('loginMessage');

            loginMessage.className = 'error';
            if (!email || !password) {
                loginMessage.textContent = 'กรุณากรอก Email และ Password';
                return;
            }

            // 1. เข้าสู่ระบบด้วย Firebase Authentication
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    // 2. ตรวจสอบข้อมูลเสริมและวันหมดอายุใน Firestore
                    return db.collection("users").doc(user.uid).get();
                })
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const now = new Date();
                        const expiry = userData.expiryDate.toDate(); // แปลง Timestamp เป็น Date Object
                        
                        // 3. ตรวจสอบวันหมดอายุ
                        if (expiry < now) {
                            // บัญชีหมดอายุ! ให้ออกจากระบบทันที
                            auth.signOut();
                            loginMessage.textContent = 'เข้าสู่ระบบล้มเหลว: บัญชีของคุณหมดอายุแล้ว กรุณาติดต่อผู้ดูแลระบบ';
                        } else {
                            // เข้าสู่ระบบสำเร็จและยังไม่หมดอายุ
                            loginMessage.className = 'success';
                            loginMessage.textContent = 'เข้าสู่ระบบสำเร็จ! สวัสดี ' + userData.email + ' (หมดอายุ: ' + expiry.toLocaleDateString('th-TH') + ')';
                            // **TODO: เปลี่ยนเส้นทางไปยังหน้า Dashboard ได้ที่นี่**
                        }
                    } else {
                        // ไม่พบข้อมูลเสริมใน Firestore
                        loginMessage.textContent = 'เข้าสู่ระบบล้มเหลว: ไม่พบข้อมูลผู้ใช้';
                    }
                })
                .catch((error) => {
                    loginMessage.className = 'error';
                    loginMessage.textContent = 'เข้าสู่ระบบล้มเหลว: ' + error.message;
                });
        }
    </script>
</body>
</html>
